// @example
// defaults to encoding buffer
// https://nodejs.org/api/child_process.html#child_process_child_process_execsync_command_options
// https://github.com/sindresorhus/execa#execasyncfile-arguments-options
// https://www.hacksparrow.com/difference-between-spawn-and-exec-of-node-js-child_process.html
// https://dzone.com/articles/understanding-execfile-spawn-exec-and-fork-in-node
// https://gist.github.com/s4y/1215700
// http://krasimirtsonev.com/blog/article/Nodejs-managing-child-processes-starting-stopping-exec-spawn

function splitSlashAndPop(str) {
  // split at every folder
  str = str.split('/')

  // remove last
  str.pop()

  return str
}

function removeNodeModulesAndBin(str) {
  str = splitSlashAndPop(str)

  // remove node modules
  return str.slice(0, str.length - 1).join('/')
}

function upDir(dir) {
  dir = splitSlashAndPop(dir)
  return dir.join('/')
}

function npmUp(currentPkgPath) {
  const {execFileSync} = require('child_process')
  return removeNodeModulesAndBin(
    execFileSync('npm', ['bin'], {
      cwd: upDir(currentPkgPath),
    }).toString())
}

function rootable(args = {depth: 1, asObj: false}) {
  const paths = {
    farthest: false,
    nearest: false,
    fellback: false,
  }
  const execa = require('execa')

  try {
    paths.nearest = removeNodeModulesAndBin(execa.sync('npm', ['bin']).stdout)
    paths.farthest = paths.nearest
    if (args.depth) {
      while (args.depth) {
        paths.farthest = npmUp(paths.farthest)
        args.depth--
      }
    }
  } catch (e) {
    console.log(e)
    paths.nearest = require('app-root-path').toString()
    paths.fellback = true
  }

  if (args.asObj) return paths
  return paths.farthest
}

module.exports = rootable
